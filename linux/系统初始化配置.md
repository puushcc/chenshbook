# LINUXåˆå§‹åŒ–é…ç½®

## 0ã€ä¿¡æ¯æ”¶é›†

> è·å–å†…æ ¸ï¼Œæ“ä½œç³»ç»Ÿå’Œè®¾å¤‡ä¿¡æ¯

```bash
ç‰ˆæœ¬ä¿¡æ¯
uname -a æ‰€æœ‰ç‰ˆæœ¬
uname -r å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
uname -n ç³»ç»Ÿä¸»æœºåå­—
uname -m Linuxå†…æ ¸æ¶æ„
å†…æ ¸ä¿¡æ¯ cat /proc/version
CPUä¿¡æ¯ cat /proc/cpuinfo
å‘å¸ƒä¿¡æ¯
cat /etc/*-release
cat /etc/issue
ä¸»æœºå hostname
æ–‡ä»¶ç³»ç»Ÿ df -a
```

> ç”¨æˆ·å’Œç»„

```bash
åˆ—å‡ºç³»ç»Ÿæ‰€æœ‰ç”¨æˆ· cat /etc/passwd
åˆ—å‡ºç³»ç»Ÿæ‰€æœ‰ç»„ cat /etc/group
åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·å¯†ç ï¼ˆåŠ å¯†ï¼‰cat /etc/shadow
æŸ¥è¯¢ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ finger
å½“å‰ç™»å½•çš„ç”¨æˆ· users who -a
ç›®å‰ç™»å½•çš„ç”¨æˆ· w
ç™»å…¥è¿‡çš„ç”¨æˆ·ä¿¡æ¯ last
æ˜¾ç¤ºç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·æœ€è¿‘ä¸€æ¬¡ç™»å½•ä¿¡æ¯ lastlog
```

>  ç”¨æˆ·å’Œæƒé™ä¿¡æ¯

```bash
å½“å‰ç”¨æˆ· whoami
å½“å‰ç”¨æˆ·ä¿¡æ¯ id
å¯ä»¥ä½¿ç”¨sudoæå‡åˆ°rootçš„ç”¨æˆ·ï¼ˆrootï¼‰ cat /etc/sudoers
åˆ—å‡ºç›®å‰ç”¨æˆ·å¯æ‰§è¡Œä¸æ— æ³•æ‰§è¡Œçš„æŒ‡ä»¤ sudo -l
```

> ç¯å¢ƒä¿¡æ¯

```bash
æ‰“å°ç³»ç»Ÿç¯å¢ƒä¿¡æ¯ env
æ‰“å°ç³»ç»Ÿç¯å¢ƒä¿¡æ¯ set
ç¯å¢ƒå˜é‡ä¸­çš„è·¯å¾„ä¿¡æ¯ echo  $PATH
æ‰“å°å†å²å‘½ä»¤ history
æ˜¾ç¤ºå½“å‰è·¯å¾„ pwd
æ˜¾ç¤ºé»˜è®¤ç³»ç»Ÿéå† cat /etc/profile
æ˜¾ç¤ºå¯ç”¨çš„shell cat /etc/shells
```

> æœåŠ¡ä¿¡æ¯

```bash
æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ ps aux
ç”±inetdç®¡ç†çš„æœåŠ¡åˆ—è¡¨ cat /etc/inetd.conf
ç”±xinetdç®¡ç†çš„æœåŠ¡åˆ—è¡¨ cat /etc/xinetd.conf
nfsæœåŠ¡å™¨çš„é…ç½® cat /etc/exports
```

> ä½œä¸šå’Œä»»åŠ¡

```bash
æ˜¾ç¤ºæŒ‡å®šç”¨æˆ·çš„è®¡åˆ’ä½œä¸šï¼ˆrootï¼‰ crontab -l -u %user%

è®¡åˆ’ä»»åŠ¡ ls -la /etc/cron*
```

> ç½‘ç»œã€è·¯ç”±å’Œé€šä¿¡

```bash
åˆ—å‡ºç½‘ç»œæ¥å£ä¿¡æ¯ /sbin/ifconfig -a
åˆ—å‡ºç½‘ç»œæ¥å£ä¿¡æ¯ cat /etc/network/interfaces
æŸ¥çœ‹ç³»ç»Ÿarpè¡¨ arp -a
æ‰“å°è·¯ç”±ä¿¡æ¯ route
æŸ¥çœ‹dnsé…ç½®ä¿¡æ¯ cat /etc/resolv.conf
æ‰“å°æœ¬åœ°ç«¯å£å¼€æ”¾ä¿¡æ¯ netstat -an
åˆ—å‡ºiptableçš„é…ç½®è§„åˆ™ iptables -L
æŸ¥çœ‹ç«¯å£æœåŠ¡æ˜ å°„ cat /etc/services
```

## 1ã€å…³é—­é˜²ç«å¢™

å…³é—­é˜²ç«å¢™æ˜¯ä¸ºäº†æ–¹ä¾¿æ—¥å¸¸ä½¿ç”¨ï¼Œä»¥å…é€ æˆå›°æ‰°ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®æ‰“å¼€ï¼ˆæ ¹æ®å®é™…æƒ…å†µä½¿ç”¨ï¼‰ã€‚
Centos7ä½¿ç”¨çš„æ˜¯firewalldï¼Œè€ŒCentos6ä½¿ç”¨çš„æ˜¯iptables

Centos7é˜²ç«å¢™æœåŠ¡è®¾ç½®å‘½ä»¤
```bash
#å…³é—­é˜²ç«å¢™å¹¶è®¾ç½®å¼€æœºä¸è‡ªåŠ¨å¯åŠ¨
systemctl stop firewalld && systemctl disable firewalld
#å…¶ä»–å‘½ä»¤
systemctl start firewalld 	#å¼€å¯
systemctl enable firewalld	#å¼€æœºè‡ªå¯
systemctl status firewalld	#æŸ¥çœ‹çŠ¶æ€
```

Centos6é˜²ç«å¢™æœåŠ¡è®¾ç½®å‘½ä»¤
```bash
#ä¸´æ—¶å…³é—­é˜²ç«å¢™å‘½ä»¤
/etc/init.d/iptables stop
/etc/init.d/iptables status
#æ°¸ä¹…å…³é—­
chkconfig iptables off
chkconfig --list |grep iptables
```
æŸ¥çœ‹å·²å¼€å‘ç«¯å£å‘½ä»¤ï¼šfirewall-cmd --list-all
å¼€æ”¾é˜²ç«å¢™ç«¯å£ï¼šfirewall-cmd --zone=public --add-port=3306/tcp --permanent
å¼€æ”¾ç«¯å£åéœ€è¦é‡æ–°åŠ è½½é˜²ç«å¢™ï¼šfirewall-cmd --reload
```bash
æŸ¥çœ‹ç‰ˆæœ¬ï¼š firewall-cmd --version
æŸ¥çœ‹å¸®åŠ©ï¼š firewall-cmd --help
æ˜¾ç¤ºçŠ¶æ€ï¼š firewall-cmd --state
æŸ¥çœ‹æ‰€æœ‰æ‰“å¼€çš„ç«¯å£ï¼š firewall-cmd --zone=public --list-ports
æ›´æ–°é˜²ç«å¢™è§„åˆ™ï¼š firewall-cmd --reload
æŸ¥çœ‹åŒºåŸŸä¿¡æ¯: firewall-cmd --get-active-zones
æŸ¥çœ‹æŒ‡å®šæ¥å£æ‰€å±åŒºåŸŸï¼š firewall-cmd --get-zone-of-interface=eth0
æ‹’ç»æ‰€æœ‰åŒ…ï¼šfirewall-cmd --panic-on
å–æ¶ˆæ‹’ç»çŠ¶æ€ï¼š firewall-cmd --panic-off
æŸ¥çœ‹æ˜¯å¦æ‹’ç»ï¼š firewall-cmd --query-panic
```

## 2ã€å…³é—­Selinux
```shell
#æ°¸ä¹…å…³é—­
sed -i 's#enforcing#disabled#g' /etc/selinux/config
#ä¸´æ—¶å…³é—­
setenforce 0
```

## 3ã€å…³é—­swapåˆ†åŒº
åœ¨æ­å»ºk8sç¯å¢ƒæ—¶éœ€è¦å…³é—­swap
>ä¸€æ—¦è§¦å‘swapï¼Œä¼šå¯¼è‡´ç³»ç»Ÿæ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒK8Sè¦æ±‚å…³é—­swapåˆ†åŒºã€‚
>å¦‚æœå¼€å¯äº† swap åˆ†åŒºï¼Œkubelet ä¼šå¯åŠ¨å¤±è´¥(å¯ä»¥é€šè¿‡å°†å‚æ•° --fail-swap-on è®¾ç½®ä¸ºfalse æ¥å¿½ç•¥ swap on)ï¼Œæ•…éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šå…³é—­ swap åˆ†åŒºï¼š

```shell
#
sudo swapoff -a
## ä¸ºäº†é˜²æ­¢å¼€æœºè‡ªåŠ¨æŒ‚è½½ swap åˆ†åŒºï¼Œå¯ä»¥æ³¨é‡Š  /etc/fstab  ä¸­ç›¸åº”çš„æ¡ç›®ï¼š
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
#é€šè¿‡ free -mæŸ¥çœ‹swapçš„çŠ¶æ€
free -m
```

## 4ã€å†…æ ¸å‚æ•°ä¼˜åŒ–

ä¿®æ”¹/etc/sysctl.confæ–‡ä»¶ã€‚æ£€æŸ¥sysctl.confæ–‡ä»¶ï¼Œå¦‚æœå·²ç»åŒ…å«éœ€è¦ä¿®æ”¹çš„å‚æ•°ï¼Œåˆ™ä¿®æ”¹è¯¥å‚æ•°çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰éœ€è¦ä¿®æ”¹çš„å‚æ•°ï¼Œåœ¨sysctl.confæ–‡ä»¶ä¸­æ·»åŠ å‚æ•°ã€‚
å¦‚ï¼š net.ipv4.tcp_fin_timeout=30 ä¿å­˜é€€å‡ºåï¼Œå¯ä»¥é‡å¯æœºå™¨ä½¿å‚æ•°ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³ä½¿å‚æ•°é©¬ä¸Šç”Ÿæ•ˆï¼Œä¹Ÿå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š sysctl -p

```bash
#æœ€å¤§è¿½è¸ªè¿æ¥æ•°ä¿®æ”¹ è°ƒä¼˜
net.nf_conntrack_max=1048576
net.netfilter.nf_conntrack_max=1048576
#å“ˆå¸Œè¡¨å¤§å°ï¼ˆæ¡¶çš„æ•°é‡ï¼‰
net.netfilter.nf_conntrack_buckets = 262144
#å“åº”æ—¶é—´ è°ƒä¼˜
net.netfilter.nf_conntrack_icmp_timeout=10
net.netfilter.nf_conntrack_tcp_timeout_syn_recv=5
net.netfilter.nf_conntrack_tcp_timeout_syn_sent=5
net.netfilter.nf_conntrack_tcp_timeout_established=300
net.netfilter.nf_conntrack_tcp_timeout_fin_wait=10
net.netfilter.nf_conntrack_tcp_timeout_time_wait=10
net.netfilter.nf_conntrack_tcp_timeout_close_wait=10
net.netfilter.nf_conntrack_tcp_timeout_last_ack=10
# æ¶ˆæ¯é˜Ÿåˆ—çš„æœ€å¤§æ¶ˆæ¯å¤§å°ï¼Œé»˜è®¤8kï¼Œå»ºè®®64kb
kernel.msgmax = 65536
# æ¶ˆæ¯é˜Ÿåˆ—å­˜æ”¾æ¶ˆæ¯çš„æ€»å­—èŠ‚æ•°
kernel.msgmnb = 163840
# TCP ç¼“å†²åŒºå†…å­˜ï¼Œè¿æ¥æ•°è¾¾åˆ°éå¸¸é«˜æ—¶å€™éœ€è¦é…ç½®å¥½
net.ipv4.tcp_mem = 786432 2097152 3145728
net.ipv4.tcp_rmem = 4096 4096 16777216
net.ipv4.tcp_wmem = 4096 4096 16777216
# socketç¼“å†²åŒºé»˜è®¤å€¼å’Œæœ€å¤§å€¼
net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
# ACCEPTç­‰å¾…é˜Ÿåˆ—é•¿åº¦ï¼Œé€‚å½“ï¼Œå¤ªå¤§äº†å †ç§¯ä¹Ÿæ— ç”¨
net.core.netdev_max_backlog = 65535
# å…è®¸æœ€å¤§å¹¶å‘è¿æ¥æ•°ï¼Œé‡è¦
net.core.somaxconn = 65535
# ä¸å±äºä»»ä½•è¿›ç¨‹çš„socketæ•°ç›®ï¼Œä¸å®œå¤ªå¤§ï¼Œé˜²æ­¢æ”»å‡»
net.ipv4.tcp_max_orphans = 65535
# SYNCç­‰å¾…é˜Ÿåˆ—é•¿åº¦ï¼Œé€‚å½“ï¼Œå¤ªå¤§äº†æ’é˜Ÿä¹Ÿæ²¡ç”¨
net.ipv4.tcp_max_syn_backlog = 65535
# ç¦ç”¨timestampï¼Œé‡è¦ï¼Œé«˜å¹¶å‘ä¸‹è®¾ç½®ä¸º0
net.ipv4.tcp_timestamps = 0
# å‘é€ SYNC+ACK çš„é‡è¯•æ¬¡æ•°ï¼Œä¸å®œå¤ªå¤§ï¼Œ5ä»¥å†…
net.ipv4.tcp_synack_retries = 1
# å‘é€SYNCçš„é‡è¯•æ¬¡æ•°ï¼Œä¸å®œå¤ªå¤§ï¼Œ5ä»¥å†…
net.ipv4.tcp_syn_retries = 1
# å…è®¸å›æ”¶TCPè¿æ¥ï¼Œé‡è¦ï¼Œå¿…é¡»ä¸º1
net.ipv4.tcp_tw_recycle = 1
# å…è®¸é‡ç”¨TCPè¿æ¥ï¼Œé‡è¦ï¼Œå¿…é¡»ä¸º1
net.ipv4.tcp_tw_reuse = 1
# æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­åï¼Œå®¢æˆ·ç«¯é‡Šæ”¾è¿æ¥çš„è¶…æ—¶ï¼Œé‡è¦ï¼Œ<30
net.ipv4.tcp_fin_timeout = 5
# å…è®¸TCPä¿æŒçš„ç©ºé—²keepaliveæ—¶é•¿ï¼Œä¸éœ€è¦å¤ªé•¿
net.ipv4.tcp_keepalive_time = 30
# ç³»ç»Ÿä½œä¸ºTCPå®¢æˆ·ç«¯è¿æ¥è‡ªåŠ¨ä½¿ç”¨çš„ç«¯å£(startï¼Œendï¼‰ï¼Œå¯å‘èµ·å¹¶å‘è¿æ¥æ•°ä¸ºend-start
net.ipv4.ip_local_port_range = 10240 65535
```

> k8sç³»ç»Ÿä¼˜åŒ–é…ç½®

```shell
cat > /etc/sysctl.d/k8s.conf << EOF
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp.keepaliv.probes = 3
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp.max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp.max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.top_timestamps = 0
net.core.somaxconn = 16384
EOF
# ç«‹å³ç”Ÿæ•ˆ
sysctl --system
```
> ç³»ç»Ÿé»˜è®¤æ–‡ä»¶æè¿°ç¬¦ä¸º1024

```bash
#æŸ¥çœ‹
ulimit -n
#ä¿®æ”¹ä¸º65535
echo "*  -  nofile 65535">>/etc/security/limits.conf
```

> æ–‡ä»¶æè¿°ç¬¦ä¼˜åŒ–ï¼ˆéƒ¨ç½²k8séœ€è¦çš„åˆå§‹åŒ–é…ç½®ï¼‰

```shell
echo '
*                soft    core            unlimited
*                hard    core            unlimited
*                soft    nproc           1000000
*                hard    nproc           1000000
*                soft    nofile          1000000
*                hard    nofile          1000000
*                soft    memlock         32000
*                hard    memlock         32000
*                soft    msgqueue        8192000
*                hard    msgqueue        8192000
' >> /etc/security/limits.conf
```
## 5ã€é…ç½®æœ¬åœ°yumæº
Linuxä¸‹ä½¿ç”¨isoæ–‡ä»¶ä½œä¸ºyumæºã€‚

```shell
#1ã€å°†linuxç³»ç»Ÿå¯¹åº”çš„ç³»ç»Ÿé•œåƒï¼ˆisoæ–‡ä»¶ï¼‰ä¸Šä¼ åˆ°æœåŠ¡å™¨
#2ã€åˆ›å»ºæŒ‚è½½è·¯å¾„ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
mkdir -p /mnt/iso
#3ã€å°†isoæ–‡ä»¶æŒ‚è½½åˆ°/mnt/iso
mount -o loop xxxx.iso /mnt/iso
#4ã€å¦‚æœ/etc/yum.repos.d/ä¸‹é¢æœ‰å…¶å®ƒçš„*.repoæ–‡ä»¶ï¼Œå…ˆåˆ›å»ºä¸ªå¤‡ä»½æ–‡ä»¶å¤¹ï¼Œå°†è¿™äº›repoå…ˆè½¬ç§»åˆ°æ–‡ä»¶å¤¹ä¸­ï¼Œè‡ªå·±å†™ä¸€ä¸ªæ–°çš„.repoçš„æ–‡ä»¶
vi /etc/yum.repos.d/file.repo
#æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š
[base-local]
name=centos7repo
baseurl=file:///mnt/iso
enabled=1
gpgcheck=0
gpgkey=file:///mnt/iso/RPM-GPG-KEY-redhat-release #å¯é€‰é…ç½®
#5ã€æ¸…é™¤cache
yum clean all
yum makecache #å°†æœåŠ¡å™¨ä¸Šçš„è½¯ä»¶åŒ…ä¿¡æ¯ ç°åœ¨æœ¬åœ°ç¼“å­˜,ä»¥æé«˜æœç´¢å®‰è£…è½¯ä»¶çš„é€Ÿåº¦
#6ã€éªŒè¯æ˜¯å¦æˆåŠŸ
yum -y install tree
#7ã€å–æ¶ˆæŒ‚è½½
umount  /mnt/iso
#8ã€å…¶ä»–
yum search è½¯ä»¶åŒ…   #æœç´¢è½¯ä»¶åŒ…
yum install è½¯ä»¶åŒ…   #å®‰è£…è½¯ä»¶åŒ…
yum remove è½¯ä»¶åŒ…  #ç§»é™¤è½¯ä»¶åŒ…
yum update         #æ›´æ–°ç³»ç»Ÿ
```
## 6ã€å‡çº§å†…æ ¸ç‰ˆæœ¬

```shell
# ä¸‹è½½åœ°å€ï¼šhttps://elrepo.org/linux/kernel/el7/x86_64/RPMS/
# ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œæ‰§è¡Œ
yum localinstall -y kernel-lt*
grub2-set-default  0 && grub2-mkconfig -o /etc/grub2.cfg
grubby --default-kernel
# é‡å¯æœåŠ¡å™¨
reboot
```
## 7ã€å®‰è£…ipvs
ipvsæ˜¯ç³»ç»Ÿå†…æ ¸ä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œå…¶ç½‘ç»œè½¬å‘æ€§èƒ½å¾ˆé«˜ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é¦–é€‰ipvsã€‚

```shell
# å®‰è£…IPVS
yum install -y conntrack-tools ipvsadm ipset conntrack libseccomp
# åŠ è½½IPVSæ¨¡å—
cat > /etc/sysconfig/modules/ipvs.modules <<EOF
#!/bin/bash
ipvs_modules="ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack"
for kernel_module in \${ipvs_modules}; do
/sbin/modinfo -F filename \${kernel_module} > /dev/null 2>&1
if [ $? -eq 0 ]; then
/sbin/modprobe \${kernel_module}
fi
done
EOF
#ææƒ
chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep ip_vs
```
## 8ã€å®‰è£…åŸºç¡€è½¯ä»¶

```shell
#å®‰è£…ä¸€äº›åŸºç¡€è½¯ä»¶ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬çš„æ—¥å¸¸ä½¿ç”¨ã€‚
yum install wget lrzsz expect vim net-tools ntp bash-completion ipvsadm ipset jq iptables conntrack sysstat libseccomp -y
## å®‰è£…å¸¸ç”¨å‘½ä»¤å·¥å…·
# å‘½ä»¤å·¥å…·æ¸…å•å¦‚ä¸‹ï¼š
# æ ¸å¿ƒå·¥å…·ï¼šdfã€duã€chkconfig
# ç½‘ç»œå·¥å…·ï¼šifconfigã€netstatã€routeã€iptables
# IPå·¥å…·ï¼šipã€ssã€pingã€tracepathã€traceroute
# DNSå·¥å…·ï¼šdigã€hostã€nslookupã€whois
# ç«¯å£å·¥å…·ï¼šlsofã€ncã€telnet
# ä¸‹è½½å·¥å…·ï¼šcurlã€wgetã€lrzsz
# ç¼–è¾‘å·¥å…·ï¼šemacsã€vim
# æµé‡å·¥å…·ï¼šiftopã€nethogs
# æŠ“åŒ…å·¥å…·ï¼štcpdump
# å‹ç¼©å·¥å…·ï¼šunzipã€zip
# ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼šgitã€subversion
```
## 9ã€æ—¶é—´åŒæ­¥
åœ¨é›†ç¾¤å½“ä¸­ï¼Œæ—¶é—´æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œä¸€æ—¦é›†ç¾¤å½“ä¸­æŸå°æœºå™¨æ—¶é—´è·Ÿé›†ç¾¤æ—¶é—´ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šå¯¼è‡´é›†ç¾¤é¢ä¸´å¾ˆå¤šé—®é¢˜ã€‚æ‰€ä»¥ï¼Œåœ¨éƒ¨ç½²é›†ç¾¤ä¹‹å‰ï¼Œéœ€è¦åŒæ­¥é›†ç¾¤å½“ä¸­çš„æ‰€æœ‰æœºå™¨çš„æ—¶é—´ã€‚

```shell
#è°ƒæ•´ç³»ç»Ÿæ—¶åŒºå¹¶åŒæ­¥æ—¶é—´
yum install ntp -y
# è®¾ç½®ç³»ç»Ÿæ—¶åŒºä¸º ä¸­å›½/ä¸Šæµ·
timedatectl set-timezone Asia/Shanghai
# å°†å½“å‰çš„UTCæ—¶é—´å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ
timedatectl set-local-rtc 0
# é‡å¯ä¾èµ–äºç³»ç»Ÿæ—¶é—´çš„æœåŠ¡
systemctl restart rsyslog
systemctl restart crond
é›†ç¾¤åŒæ­¥æ—¶é—´
#æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦å®‰è£…ntpåŒ…ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…éœ€è¦æ‰§è¡Œyum install ntp -yå®‰è£…
rpm -q ntp
#æŸ¥çœ‹ntpæ˜¯å¦è®¾ç½®ä¸ºå¼€å¯å¯åŠ¨çŠ¶æ€
systemctl is-enabled ntpd
#è®¾ç½®ä¸ºå¼€æœºè‡ªå¯åŠ¨å¹¶å¯åŠ¨ntp
systemctl enable ntpd
systemctl start ntpd.service
```
é»˜è®¤æƒ…å†µä¸‹ntpæ˜¯ä»å¤–ç½‘æ—¶é—´æœåŠ¡å™¨æ¥æ›´æ–°æ—¶é—´çš„ï¼Œåœ¨é›†ç¾¤ä¸­ä½¿ç”¨åªè¦ä¿è¯é›†ç¾¤ä¸­æ‰€æœ‰çš„æœåŠ¡å™¨æ—¶é—´ä¸€è‡´å³å¯ï¼Œæ‰€ä»¥å…ˆé…ç½®å…¶ä¸­ä¸€å°æœåŠ¡å™¨ä¸ºæ—¶é—´æœåŠ¡å™¨ï¼Œå…¶ä»–æœåŠ¡å™¨ç›¸å¯¹æ¥è¯´ä¸ºè¿™å°æ—¶é—´æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œä»æ—¶é—´æœåŠ¡å™¨ä¸Šè·å–æ—¶é—´æ•°æ®ï¼Œä»è€Œé¿å…è”ç½‘ï¼Œå¯ç”¨æ€§æ›´é«˜

>é¦–å…ˆæ˜¯æ—¶é—´æœåŠ¡å™¨é…ç½®ï¼šæ—¶é—´æœåŠ¡å™¨çš„IPï¼š192.168.0.3

```bash
#ä¿®æ”¹ntpé…ç½®æ–‡ä»¶:
vim /etc/ntp.conf
#1ä¿®æ”¹ï¼ˆé›†ç¾¤åœ¨å±€åŸŸç½‘ä¸­ï¼Œä¸ä½¿ç”¨å…¶ä»–äº’è”ç½‘ä¸Šçš„æ—¶é—´ï¼‰æ³¨é‡Šä¸‹é¢4è¡Œ
#server 0.centos.pool.ntp.org iburst
#server 1.centos.pool.ntp.org iburst
#server 2.centos.pool.ntp.org iburst
#server 3.centos.pool.ntp.org iburst
#2æ·»åŠ ï¼ˆæˆæƒ192.168.0.0-192.168.0.255ç½‘æ®µä¸Šçš„æ‰€æœ‰æœºå™¨å¯ä»¥ä»è¿™å°æœºå™¨ä¸ŠæŸ¥è¯¢å’ŒåŒæ­¥æ—¶é—´ï¼‰æ·»åŠ ä¸€è¡Œ
restrict 192.168.0.0 mask 255.255.255.0 nomodify notrap
#3æ·»åŠ ï¼ˆå½“è¯¥èŠ‚ç‚¹ä¸¢å¤±ç½‘ç»œè¿æ¥ï¼Œä¾ç„¶å¯ä»¥é‡‡ç”¨æœ¬åœ°æ—¶é—´ä½œä¸ºæ—¶é—´æœåŠ¡å™¨ä¸ºé›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹æä¾›æ—¶é—´åŒæ­¥ï¼‰
server 127.127.1.0
fudge 127.127.1.0 stratum 10
#ä¿®æ”¹/etc/sysconfig/ntpd æ–‡ä»¶å¢åŠ å†…å®¹å¦‚ä¸‹ï¼ˆè®©ç¡¬ä»¶æ—¶é—´ä¸ç³»ç»Ÿæ—¶é—´ä¸€èµ·åŒæ­¥ï¼‰
vim /etc/sysconfig/ntpd
#å¢åŠ å†…å®¹
SYNC_HWCLOCK=yes
#é‡å¯å¯åŠ¨ntpdæœåŠ¡:
systemctl restart ntpd
```
>å®¢æˆ·ç«¯æœåŠ¡å™¨é…ç½®ï¼š

```bash
#ä¿®æ”¹ntpé…ç½®æ–‡ä»¶:
vim /etc/ntp.conf
#æ·»åŠ ä¸€è¡ŒæŒ‡å®šæ—¶é—´æœåŠ¡å™¨ä½ç½®ï¼š
server 192.168.0.3
#åœæ­¢ntpdæœåŠ¡:
systemctl stop ntpd
#æ‰‹åŠ¨å¼ºåˆ¶åŒæ­¥æ—¶é—´ï¼Œ192.168.0.3æ˜¯ntpæœåŠ¡å™¨IP
ntpdate 192.168.0.3
# ç»§ç»­å¯åŠ¨æœåŠ¡
systemctl start ntpd
#ntpq -pæŸ¥çœ‹ç½‘ç»œä¸­çš„NTPæœåŠ¡å™¨
#åŒæ­¥é˜¿é‡Œäº‘æœåŠ¡å™¨æ—¶é—´
ntpdate ntp1.aliyun.com
```

>å…¶ä»–ï¼šæ‰‹åŠ¨è®¾ç½®æ—¶é—´

```shell
#æŸ¥çœ‹æ—¶é—´
date
#è®¾ç½®æ—¶é—´
date --set "03/01/17 10:15"	(æœˆ/æ—¥/å¹´ æ—¶:åˆ†:ç§’)
#æŸ¥çœ‹ç¡¬ä»¶æ—¶é—´
hwclock/clock 
```

## 10ã€NFSå…±äº«å­˜å‚¨
åŸç†è¯´æ˜
![nfsåŸç†å›¾](./Pasted%20image%2020220610151953.png)

>NFSæœåŠ¡ç«¯éƒ¨ç½²


```bash
yum -y install nfs-utils rpcbind   # nfs æœåŠ¡å®‰è£…ï¼Œå®‰è£…nfs-utilsä¼šè‡ªåŠ¨å®‰è£…rpcbindï¼Œæ‰€ä»¥è¿™é‡Œrpcbindå…¶å®æ˜¯å¯ä»¥çœç•¥
systemctl start rpcbind         # rpcbindæœåŠ¡å¯åŠ¨ï¼Œ
systemctl start nfs-server       # nfsæœåŠ¡å¯åŠ¨ï¼ŒæœåŠ¡åç”¨nfsä¹Ÿå¯ä»¥
systemctl enable rpcbind       # rpcbindæœåŠ¡å¼€æœºè‡ªå¯
systemctl enable nfs-server     # nfsæœåŠ¡å¼€æœºè‡ªå¯
#å¯åŠ¨ä¹‹åå¯ä»¥é€šè¿‡netstat -ntlpæ£€æŸ¥111ç«¯å£æ˜¯å¦ç›‘å¬çŠ¶æ€ï¼Œé€šè¿‡rpcinfo -p localhostæŸ¥çœ‹rpcbindæœåŠ¡æƒ…å†µã€‚
systemctl status nfs-server
systemctl status rpcbind
netstat -nputl |grep 111
#åˆ›å»ºå…±äº«å­˜å‚¨çš„ç›®å½•å¹¶æˆæƒï¼š
mkdir /tmp/lihp
chmod 777 /tmp/lihp
#åœ¨/etc/exportsä¸­è®¾ç½®æ­¤ç›®å½•ä¸ºNFSå…±äº«ç›®å½•ï¼Œå¹¶è®¾ç½®å…±äº«å‚æ•°ï¼šå¯¹æ‰€æœ‰ç”¨æˆ·å…±äº«ã€‚
#NFS æœåŠ¡ç¨‹åºçš„é…ç½®æ–‡ä»¶ä¸º /etc/exportsï¼Œå®šä¹‰è¦å…±äº«çš„ç›®å½•ä¸ç›¸åº”çš„æƒé™ï¼Œé»˜è®¤æƒ…å†µä¸‹é‡Œé¢æ²¡æœ‰ä»»ä½•å†…å®¹ã€‚
vim /etc/exports
#é…ç½®æ ¼å¼æ˜¯ï¼šâ€œå…±äº«ç›®å½•çš„è·¯å¾„   å…è®¸è®¿é—®çš„ NFS å®¢æˆ·ç«¯ï¼ˆå…±äº«æƒé™å‚æ•°ï¼‰â€ã€‚
/tmp/lihp *(insecure,fsid=0,rw,sync,no_root_squash,acl)
#ç¼–è¾‘/etc/exportså®Œæˆåæ‰§è¡Œexportfs -rv è¿›è¡Œåˆ·æ–°ï¼ˆ -r æ˜¯é‡æ–°å¯¼å‡ºæ‰€æœ‰ç›®å½•ï¼Œ-væ˜¯å¯¼å‡ºé€‰é¡¹åˆ—è¡¨ï¼‰
exportfs -rv
showmount -e
```
>NFSå®¢æˆ·ç«¯éƒ¨ç½²

åœ¨å®¢æˆ·ç«¯ä¸Šï¼Œå’ŒæœåŠ¡ç«¯çš„åŒºåˆ«å°±æ˜¯ä¸ç”¨å¯åŠ¨nfsæœåŠ¡ï¼ˆéœ€è¦å¯åŠ¨rpcbindæœåŠ¡ï¼‰ã€‚
ä½¿ç”¨showmountå‘½ä»¤æŸ¥çœ‹nfsæœåŠ¡å™¨å…±äº«å‡ºæ¥çš„ç›®å½•ï¼Œç„¶åå¯ä»¥mountæŒ‚è½½ã€‚

```bash
showmount -e 192.168.101.3
#å®¢æˆ·ç«¯åˆ›å»ºå…±äº«å­˜å‚¨ç›®å½•ï¼ˆå¯è‡ªå®šä¹‰ï¼‰ï¼š
mkdir /tmp/lihp
#æŒ‚è½½ï¼š
mount -t nfs 192.168.101.49:/tmp/lihp/ /tmp/lihp/
#åœ¨å®¢æˆ·ç«¯é…ç½®è‡ªåŠ¨æŒ‚è½½ï¼š
vim /etc/fstab
192.168.101.49:/tmp/lihp/ /tmp/lihp/   nfs   defaults,_netdev 0 0
```

## 11ã€ä¸»æœºåä¿®æ”¹
>ä¿®æ”¹ä¸»æœºåï¼š

```shell
#ä½¿ç”¨hostnameï¼Œä¸´æ—¶æ›´æ”¹ï¼Œç³»ç»Ÿé‡å¯åä¼šå¤±æ•ˆ
hostname [ä½ çš„ä¸»æœºå]
#ä½¿ç”¨hostnamectl
hostnamectl set-hostname [ä½ çš„ä¸»æœºå]
#æ°¸ä¹…ä¿®æ”¹
vim /etc/hostname
#localhost.localdomain
test
```
>æŸ¥çœ‹ä¸»æœºåï¼š

```shell
hostname
```

## 12ã€hostsä¸»æœºæ˜ å°„

```shell
#ç¼–è¾‘hostsæ–‡ä»¶ï¼š
vim /etc/hosts
#æ·»åŠ ä¸»æœºæ˜ å°„ï¼š
10.0.0.1   HOSTNAME1
10.0.0.2   HOSTNAME2
#å¦‚æœèƒ½pingé€šé…ç½®çš„hostnameåˆ™é…ç½®æˆåŠŸã€‚
```

## 13ã€ansible
## 14ã€å…å¯†é…ç½®

>åˆ›å»ºsshå¯†é’¥å‘½ä»¤

```bash
ssh-keygen
```

> åˆ›å»ºå¯†é’¥å‘½ä»¤åçš„æ“ä½œ
```shell
# ç”Ÿæˆçš„å¯†é’¥æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œç›´æ¥å›è½¦é»˜è®¤ä¸º/root/.ssh/id_rsa
Enter file in which to save the key (/root/.ssh/id_rsa):
# åˆ›å»ºå¯†é’¥çš„å¯†é’¥ï¼Œç›´æ¥å›è½¦ï¼Œå¯ä»¥ä¸å¡«
Enter passphrase (empty for no passphrase):
# å†æ¬¡ç¡®è®¤å¯†é’¥çš„å¯†ç ï¼Œç›´æ¥å›è½¦
Enter same passphrase again:
# åˆ›å»ºç»“æœ
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
.....
```
>æŸ¥çœ‹è¿›å…¥ç›®å½•æŸ¥çœ‹ç”Ÿæˆçš„å¯†é’¥æ–‡ä»¶

```shell
#æŸ¥çœ‹ç”Ÿæˆçš„å¯†é’¥æ–‡ä»¶
ll /root/.ssh/
	id_rsa  #æœ¬æœºç§é’¥
	id_rsa.pub #æœ¬æœºå…¬é’¥	
#æŸ¥çœ‹å¹¶æ‹·è´å…å¯†å…¬é’¥
cat id_rsa.pub
```

>å°†å…¬é’¥ä¼ ç»™éœ€è¦ç™»å½•çš„è¿œç¨‹æœåŠ¡å™¨
```shell
#ä½¿ç”¨ssh-copy-id ipå°†å…¬é’¥ä¼ é€åˆ°è¿œç¨‹æœåŠ¡å™¨
ssh-copy-id -i id_rsa.pub root@APP1
```
>QA

1ã€å¦‚æœæ‰¾ä¸åˆ°ssh-copy-idå‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ‹·è´å¯†é’¥


```bash
cat ~/.ssh/id_*.pub | ssh root@192.168.114.43 'cat >> .ssh/authorized_keys'
```
2ã€Authentication refused: bad ownership or modes for file /home/btms/.ssh/authorized_keys

```bash
sshdä¸ºäº†å®‰å…¨ï¼Œå¯¹å±ä¸»çš„ç›®å½•å’Œæ–‡ä»¶æƒé™æœ‰æ‰€è¦æ±‚ã€‚å¦‚æœæƒé™ä¸å¯¹ï¼Œåˆ™sshçš„å…å¯†ç ç™»é™†ä¸ç”Ÿæ•ˆã€‚æ£€æµ‹ç›®å½•æƒé™ï¼ŒæŠŠä¸ç¬¦åˆè¦æ±‚çš„æŒ‰è¦æ±‚è®¾ç½®æƒé™å³å¯ã€‚
- ç”¨æˆ·ç›®å½•æƒé™ä¸º 755 æˆ–è€… 700ï¼Œå°±æ˜¯ä¸èƒ½æ˜¯77xã€‚
- .sshç›®å½•æƒé™ä¸€èˆ¬ä¸º755æˆ–è€…700ã€‚
- rsa_id.pub åŠauthorized_keysæƒé™ä¸€èˆ¬ä¸º644
- rsa_idæƒé™å¿…é¡»ä¸º600
```


## 15ã€ç³»ç»Ÿå®‰å…¨è®¾ç½®

> ä¸ºç³»ç»Ÿæ·»åŠ æ“ä½œç”¨æˆ·

```bash
useradd puushcc
passwd puushcc
```

> ç”¨æˆ·ææƒ

```shell
#å¯ä»¥è¿œç¨‹ç™»å½•çš„è´¦å·ï¼š
awk '/\$1|\$6/{print $1}' /etc/shadow
#æŸ¥çœ‹å“ªäº›ç”¨æˆ·ä¸ºrootæƒé™ï¼š
cat /etc/passwd | grep x:0
#æŸ¥è¯¢ sudo æƒé™è´¦æˆ·
more /etc/sudoers | grep -v "^#\|^$" | grep "ALL=(ALL)"
```

> ä¼šè¯è¶…æ—¶

```shell
vim /etc/ssh/sshd_config
#å°†ä»¥ä¸‹å†…å®¹è®¾ç½®ä¸ºï¼š
ClientAliveInterval 600
ClientAliveCountMax 0
#ä»¥ä¸Šè¡¨ç¤º10åˆ†é’Ÿé—²ç½®åï¼Œè‡ªåŠ¨æ³¨é”€å¹¶ç»“æŸä¼šè¯ã€‚
```

> ç™»é™†å¤±è´¥é”å®š

```bash
cat /etc/ssh/sshd_configÂ Â | grep MaxAuth
MaxAuthTries 1 //è¿œç¨‹ç”¨æˆ·é€šè¿‡sshè¿æ¥ç™»å½•2æ¬¡å¤±è´¥åè‡ªåŠ¨ç»“æŸä¼šè¯ 
```

> å¯†ç ç­–ç•¥

```shell
cat /etc/login.defs | grep PASS | grep -v ^#
PASS_MAX_DAYSÂ Â  90 //å£ä»¤æœ€å¤§ä½¿ç”¨æ—¥æœŸ90å¤©
PASS_MIN_DAYSÂ Â  0 //è‹¥è®¾ç½®ä¸º2ï¼Œåˆ™è®¾ç½®å¯†ç 2å¤©åæ‰å¯ä»¥å†æ¬¡æ›´æ”¹å¯†ç ï¼Œå³å¯†ç è‡³å°‘è¦ä¿ç•™çš„å¤©æ•°
PASS_MIN_LENÂ Â Â Â 8 //å£ä»¤æœ€å°é•¿åº¦8ä½
PASS_WARN_AGEÂ Â  7 //å£ä»¤è¿‡æœŸå‰7å¤©è­¦å‘Š 


cat /etc/pam.d/system-auth | tail -n 2 && grep ^#password /etc/pam.d/system-auth
passwordÂ Â Â Â requiredÂ Â Â Â Â Â pam_cracklib.so difok=3 minlen=8 dcredit=-1,lcredit=-1 ocredit=-1 maxrepeat=3
passwordÂ Â Â Â requiredÂ Â Â Â Â Â pam_unix.so use_authtok nullok md5
#passwordÂ Â Â Â requisiteÂ Â Â Â  pam_cracklib.so try_first_pass retry=3 //æ³¨é‡Šè¿™ä¸€è¡Œåï¼Œæ— æ³•ä¿®æ”¹å¯†ç 
```

> ç¦æ­¢rootè¿œç¨‹ç™»é™†

- å¤‡ä»½é…ç½®æ–‡ä»¶

```bash
cd /etc/ssh/
cp sshd_config sshd_config.bak
```
- ä¿®æ”¹é…ç½®

```shell
vim /etc/ssh/sshd_config
#æ·»åŠ ä»¥ä¸‹é…ç½®
Prot 2388 				#å°†é»˜è®¤22ç«¯å£ä¿®æ”¹ä¸º2388
PermitRootLogin noÂ Â     #ä¸å…è®¸rootç”¨æˆ·ä½¿ç”¨sshç™»å½•
PermitEmptyPasswords no #ä¸å…è®¸ä½¿ç”¨ç©ºå¯†ç ç™»å½•
UseDNS no               #ä¸å…è®¸ä½¿ç”¨DNSè§£æ
```


## 16ã€ç£ç›˜æŒ‚è½½

## 17ã€é…ç½®IPåœ°å€
```bash
#æ–‡ä»¶ä½ç½®æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿå¯èƒ½ä¼šä¸ä¸€è‡´ï¼Œä¸‹é¢ä¸ºé…ç½®ç¤ºä¾‹
vim /etc/sysconfig/network-scripts/ifcfg-ens33

#é‡å¯ç½‘å¡
systemctl restart network
```

## 18ã€ç”¨æˆ·suåˆ‡æ¢åˆ°rootæ—¶ä¸ç”¨è¾“å…¥å¯†ç 
```bash
#ä¿®æ”¹/etc/pam.d/suè®©wheelç»„
vim /etc/pam.d/su
#å¯ç”¨è¿™æ¡ğŸ‘‡ä½¿å¾—wheelæˆå‘˜suåˆ°rootä¸ç”¨è¾“å¯†ç 
auth           sufficient      pam_wheel.so trust use_uid
#å¯ç”¨è¿™æ¡ğŸ‘‡ä½¿å¾—éwheelæˆå‘˜æ— æ³•åˆ‡æ¢åˆ°root
auth           required        pam_wheel.so use_uid
```

